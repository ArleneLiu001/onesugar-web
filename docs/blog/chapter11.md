#  微信小程序兼容企业微信小程序分析

### 一，将微信小程序用到企业微信里面可行性：
可以。企业微信移动客户端从2.5.8版本开始，已内置微信小程序基础库，开发者仅需做一些适配工作，即可将微信小程序移植到企业微信上运行。
### 二，明确需求：
1. 针对只需企业内部员工使用的小程序，属于企业内部开发，参考企业微信官方企业内部开发文档。
2. 需放到企业微信应用市场，供其他企业搜索到并安装使用时，属于第三方应用，开发时参考企业微信第三方应用开发文档。

### 三，企业微信小程序开发工具以及体验版本设置：
企业微信小程序的开发通过微信小程序模拟器插件来实现。

开发工具：使用微信开发工具---->安装企业微信开发插件--->切换企业微信小程序模式即可进行开发。

参考文档：
https://work.weixin.qq.com/api/doc/90000/90136/92380

体验版本设置：在开发工具里面扫码体验-->使用企业微信扫描二维码打开小程序开发版-->配置体验版-->选择体验成员后，发送体验邀请。

参考文档：https://work.weixin.qq.com/api/doc/90000/90136/92380

 ### 四，企业微信小程序开发流程：
 1. 微信公众平台注册小程序帐号
2. 开发者在开发者工具环境完成开发调试，同时可使用企业微信的专有接口做针对性的开发。
3. 提交小程序审核并发布
4. 小程序关联到第三方应用或者小程序关联到企业微信

 前三条通用，和微信小程序开发过程一致。
 根据使用范围的不同，企业微信小程序有两种关联方式。
 ##### 针对只需企业内部员工使用时：
1. 可前往企业微信管理后台-进入应用与小程序-小程序-关联小程序 详情
2. 登录小程序管理后台-设置tab-关联设置，找到关联到企业微信-前往关联的入口。

参考文档：https://work.weixin.qq.com/api/doc/90000/90136/92370
##### 需放到企业微信应用市场，供其他企业使用时：
1. 申请成为第三方服务商：入口：https://open.work.weixin.qq.com/
2. 服务商登录第三方管理系统->应用管理->小程序->关联小程序，即可将小程序关联到第三方应用

参考文档：https://work.weixin.qq.com/api/doc/90001/90144/92425

### 五，兼容问题：
#### 说明：
1. 小程序在微信环境中运行时，不支持调用企业微信专有接口，需要进行对应的兼容处理。
2. 由于平台有差异性，微信小程序运行到企业微信，会有一定适配工作；

#### 平台差异性适配：
##### 账号体系适配：
 ###### 身份识别：  
微信端---通过登录接口获取个人用户的身份信息。 通过获取用户的openid来唯一标识一个用户。 
企业微信端---通过登录接口获取当前企业的员工身份信息。通过获取用户的userid来唯一标识一个员工。
###### 运行环境区分：
调用异步接口 wx.getSystemInfo 或者同步接口 wx.getSystemInfoSync 获取。在企业微信运行时，会额外返回一个environment字段并赋值为 “wxwork”，在微信里面运行时则不返回该字段。建议开发者在小程序的app.js里面对环境变量进行捕获并作为全局变量进行缓存。

##### API接口适配：  
 结合目前优软商城微信小程序的api使用情况，可能需要适配的api有（以下API企业微信小程序不支持）：
 1. 动态设置置顶栏文字内容。（wx.setTopBarText()）
2. 延迟一部分操作到下一时间执行。(wx.nextTick())
3. 监听窗口尺寸变化：(wx.onWindowResize())
4. 显示当前页面的转发按钮。(wx.showShareMenu())



### 六，使用微信小程序开发企业微信小程序，目前发现的问题：
##### 组件问题：
1. 样式中，使用view标签直接定义的样式报错。  
包含文件：u-orderBox.vue，u-productListContent.vue，u-modal.vue，u-addCart.vue，mescroll-uni.vue等  。修改建议：将样式中直接使用view来设置的样式改为通过添加类名设置样式。
2.  我的页面：打开公司选择框，点击灰色区域无法关闭。

##### 页面兼容问题：
1. 购物车页面报错：Q1: 有些字段报‘undefined’或者‘not defined’，需做兼容处理。     Q2: filter过滤器加载异常，导致页面报错。  
2. 结算页面报错：1.有些字段报‘undefined’或者‘not defined’，需做兼容处理。 
3. 结算方式选择异常。
4. 买卖家页面：涉及在model层标签内的字段做格式处理的情况都会报错，需做兼容。

##### API兼容问题：
1.延迟一部分操作到下一时间执行方法。(wx.nextTick())

##### 开发工具问题：
1. 在微信开发工具中，切入企业微信开发时，鼠标放入页面后消失。
2. 开发工具在运行企业微信时，切换项目设置-调试基础库版本版本异常。

##### 企业微信授权登录以及获取用户信息问题：
1. 在企业微信登录中，获取用户信息时，企业微信的jscode2session请求url与微信的不同，后台要做处理。  
 参考文档：https://work.weixin.qq.com/api/doc/90001/90144/92423
2. 获取企业成员的头像信息兼容。在微信小程序中，直接通过uni.getUserInfo获取，企业微信中，需要专有的api：wx.qy.getAvatar 获取。



##### 其他问题：
1. 对于较低版本的企业微信，先提示自动更新版本的适配。
2. 配置体验版本时：提示当前小程序已在其他企业关联（目前可能是因为未做关联的原因）。


### 七，作为第三方服务商发布到应用平台时：
配置流程比较繁琐，需要服务端评估可行性。  
参考文档：https://blog.csdn.net/anyuetiantang/article/details/97516853

### 八，总结：
微信小程序中大部分功能在企业微信场景中都可以正常使用。针对目前暴露的问题，大部分经过修改以及和服务端配合都可以做好兼容处理。如果能顺利配置并发布到第三方平台，那么使用微信小程序开发企业微信小程序，是一种省时省力，方便快捷的一种可选方案。